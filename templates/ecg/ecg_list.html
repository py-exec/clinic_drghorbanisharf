{% extends "base.html" %}
{% load static %}
{% block title %}ูุณุช ููุงุฑ ููุจ (ECG){% endblock %}

{% block content %}
<h2 class="mb-4 text-center">ูุณุช ููุงุฑ ููุจ (ECG)</h2>

<div class="card">
    <!-- ูุฏุฑ -->
    <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
        <h5 class="mb-0">ฺฏุฒุงุฑุดโูุง ECG ุซุจุชโุดุฏู</h5>
        <div class="d-flex flex-wrap gap-2 align-items-center">

            <!-- ุชุนุฏุงุฏ ููุงุด -->
            <select id="per-page-select" class="form-select form-select-sm" style="width: 100px;">
                <option value="10">10 ุชุง</option>
                <option value="25">25 ุชุง</option>
                <option value="50" selected>50 ุชุง</option>
                <option value="100">100 ุชุง</option>
            </select>

            <!-- ุงูุฒูุฏู -->
            <a href="{% url 'ecg:ecg-create' patient_id=1 %}" class="btn btn-success btn-sm">
                โ ุงูุฒูุฏู ECG
            </a>

            <!-- PDF -->
            <button class="btn btn-outline-danger btn-sm">๐จ ุฎุฑูุฌ PDF</button>
        </div>
    </div>

    <!-- ุฌุฏูู -->
    <div class="card-body pt-0">
        <div id="ecg-table">
  {% include "ecg/partials/_ecg_table.html" %}
        </div>

    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const ecgSocket = new WebSocket(`ws://${window.location.host}/ws/reception/list/`);

ecgSocket.onopen = () => console.log("โ WebSocket ECG ูุตู ุดุฏ");
ecgSocket.onclose = () => console.warn("โ WebSocket ECG ูุทุน ุดุฏ");
ecgSocket.onerror = (err) => console.error("๐ซ ุฎุทุง ุฏุฑ WebSocket ECG:", err);

ecgSocket.onmessage = function(event) {
  const data = JSON.parse(event.data);
  console.log("๐ฉ ูพุงู WebSocket ุฏุฑุงูุช ุดุฏ:", data);

  if (data.service_type === "ecg" && ["created", "updated", "deleted"].includes(data.action)) {
    console.log("๐ ุฏุฑุฎูุงุณุช ุจุฑูุฒุฑุณุงู ุฌุฏูู ECG...");
    fetch("/ecg/partial/table/")
      .then(res => {
        if (!res.ok) throw new Error("โ ูุถุนุช ูพุงุณุฎ fetch ูุงููุงุณุจ ุจูุฏ!");
        return res.json();
      })
      .then(data => {
        console.log("โ ุฌุฏูู ECG ุฏุฑุงูุช ุดุฏ:", data);
        document.getElementById("ecg-table").innerHTML = data.html;
      })
      .catch(err => console.error("โ ุฎุทุง ุฏุฑ ุจุฑูุฒุฑุณุงู ุฌุฏูู ECG:", err));
  } else {
    console.log("โน๏ธ ุงู ูพุงู ุฑุจุท ุจู ECG ูุฏุงุดุช ุง ุงฺฉุดู ูุนุชุจุฑ ูุจูุฏ.");
  }
};
</script>
{% endblock %}
