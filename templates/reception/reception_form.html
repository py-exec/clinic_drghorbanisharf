{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Ø«Ø¨Øª Ù¾Ø°ÛŒØ±Ø´ Ø¬Ø¯ÛŒØ¯{% endblock %}

{% block content %}
    <h4 class="py-3 mb-4">
        <span class="text-muted fw-light">Ù¾Ø°ÛŒØ±Ø´ /</span> Ø«Ø¨Øª Ù¾Ø°ÛŒØ±Ø´ Ø¨Ø±Ø§ÛŒ "{{ patient.user.get_full_name }}"
    </h4>

    <div class="card">
        <div class="card-body">
            <form method="post" novalidate id="reception-form">
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø± -->
                <fieldset class="border p-3 mb-4 rounded">
                    <legend class="w-auto px-2 small">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±</legend>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                            <input type="text" class="form-control" value="{{ patient.user.get_full_name }}" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ú©Ø¯ Ù…Ù„ÛŒ</label>
                            <input type="text" class="form-control" value="{{ patient.user.national_code }}" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÙ†Ø¯Ù‡</label>
                            <input type="text" class="form-control" value="{{ patient.record_number }}" readonly>
                        </div>
                    </div>
                </fieldset>

                <!-- ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø°ÛŒØ±Ø´ -->
                <fieldset class="border p-3 mb-4 rounded">
                    <legend class="w-auto px-2 small">ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø°ÛŒØ±Ø´</legend>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="{{ form.service_level.id_for_label }}" class="form-label">
                                {{ form.service_level.label }}
                                {% if form.service_level.field.required %}
                                    <span class="text-danger">*</span>
                                {% endif %}
                            </label>
                            {{ form.service_level }}
                            {% for error in form.service_level.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="col-md-8">
                            <label class="form-label">
                                {{ form.services.label }}
                                {% if form.services.field.required %}
                                    <span class="text-danger">*</span>
                                {% endif %}
                            </label>
                            <div class="form-check-container border rounded p-3"
                                 style="max-height: 200px; overflow-y: auto;">
                                {% for service in form.fields.services.queryset %}
                                    <div class="form-check mb-2">
                                        <input type="checkbox"
                                               name="services"
                                               value="{{ service.pk }}"
                                               id="service_{{ service.pk }}"
                                               class="form-check-input"
                                               data-amount="{{ service.amount }}"
                                               {% if service in form.initial.services %}checked{% endif %}
                                        >
                                        <label class="form-check-label" for="service_{{ service.pk }}">
                                            {{ service }}
                                        </label>
                                    </div>
                                {% empty %}
                                    <div class="alert alert-warning mb-0 small">
                                        Ù‡ÛŒÚ† Ø®Ø¯Ù…ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.
                                    </div>
                                {% endfor %}
                            </div>


                            {% for error in form.services.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </fieldset>

                <!-- ğŸ’³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ -->
                <fieldset class="border p-3 mb-4 rounded">
                    <legend class="w-auto px-2 small">ğŸ’³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª</legend>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ø²ÛŒÙ†Ù‡ Ø®Ø¯Ù…Ø§Øª (Ø±ÛŒØ§Ù„)</label>
                            <input type="text" id="total-cost" class="form-control"
                                   value="{{ form.initial.total_service_cost|default:"0"|intcomma }}" readonly>
                        </div>

                        <div class="col-md-3">
                            <label for="{{ form.cash_amount.id_for_label }}" class="form-label">
                                {{ form.cash_amount.label }}
                            </label>
                            {{ form.cash_amount }}
                            {% for error in form.cash_amount.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="col-md-3">
                            <label for="{{ form.card_amount.id_for_label }}" class="form-label">
                                {{ form.card_amount.label }}
                            </label>
                            <input type="text" id="{{ form.card_amount.id_for_label }}"
                                   name="{{ form.card_amount.name }}" class="form-control"
                                   value="{{ form.card_amount.value|default:"0" }}" readonly>
                            {% for error in form.card_amount.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Ø¬Ù…Ø¹ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ (Ø±ÛŒØ§Ù„)</label>
                            <input type="text" id="total-paid" class="form-control"
                                   value="{{ form.initial.total_payment|default:"0"|intcomma }}" readonly>
                        </div>
                    </div>
                </fieldset>

                <!-- ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª -->
                <fieldset class="border p-3 mb-4 rounded">
                    <legend class="w-auto px-2 small">ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</legend>
                    <div class="row">
                        <div class="col-12">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                {{ form.notes.label }}
                            </label>
                            {{ form.notes }}
                            {% for error in form.notes.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </fieldset>

                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
                <div class="d-flex justify-content-between">
                    <div>
                        <a href="{% url 'reception:list' %}" class="btn btn-secondary">Ø¨Ø§Ø²Ú¯Ø´Øª</a>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø°ÛŒØ±Ø´</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const serviceCheckboxes = document.querySelectorAll("input[type=checkbox][name^='services']");
            const cashInput = document.getElementById("id_cash_amount");
            const cardInput = document.getElementById("id_card_amount");
            const totalServiceCostInput = document.getElementById("total-cost");
            const totalPaidInput = document.getElementById("total-paid");
            const form = document.getElementById("reception-form");

            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±ÛŒØ¯â€ŒØ§ÙˆÙ†Ù„ÛŒ Ø¨ÙˆØ¯Ù† Ú©Ø§Ø±Øªâ€ŒØ®ÙˆØ§Ù†
            if (cardInput) {
                cardInput.readOnly = true;
            }

            function parseIntSafe(val) {
                return parseInt(val.replace(/,/g, '')) || 0;
            }

            function getAmountFromService(el) {
                const amount = el.getAttribute("data-amount");
                return parseInt(amount || "0", 10);
            }

            function calculateServiceTotal() {
                let total = 0;
                serviceCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        total += getAmountFromService(cb);
                    }
                });
                return total;
            }

            function calculateAndUpdate() {
                const totalServices = calculateServiceTotal();
                const cash = parseIntSafe(cashInput.value || "0");
                const card = Math.max(totalServices - cash, 0);
                const totalPaid = cash + card;

                // ğŸ‘‡ Ù…Ù‚Ø¯Ø§Ø± Ø¹Ø¯Ø¯ÛŒ Ø®Ø§Ù… Ø¨Ø¯ÙˆÙ† Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
                cardInput.value = card;

                // ğŸ‘‡ ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù…Øªâ€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ readonly ÛŒØ§ Ù†Ù…Ø§ÛŒØ´ Ø¹Ù…ÙˆÙ…ÛŒ
                totalServiceCostInput.value = totalServices.toLocaleString("fa-IR");
                totalPaidInput.value = totalPaid.toLocaleString("fa-IR");

                // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ
                [cashInput, totalPaidInput].forEach(input => {
                    input.classList.remove("is-invalid");
                    input.setCustomValidity("");
                });

                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…Ù†ÙÛŒ Ø¨ÙˆØ¯Ù† ÛŒØ§ Ø¨ÛŒØ´ØªØ± Ø¨ÙˆØ¯Ù† Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ
                if (cash < 0) {
                    cashInput.classList.add("is-invalid");
                    cashInput.setCustomValidity("Ù…Ù‚Ø¯Ø§Ø± Ù†Ù‚Ø¯ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯.");
                } else if (totalPaid > totalServices) {
                    totalPaidInput.classList.add("is-invalid");
                    totalPaidInput.setCustomValidity("Ø¬Ù…Ø¹ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø§Ø² Ù‡Ø²ÛŒÙ†Ù‡ Ø®Ø¯Ù…Ø§Øª Ø¨ÛŒØ´ØªØ± Ø§Ø³Øª.");
                }
            }


            // Ù„ÛŒØ³Ù†Ø±Ù‡Ø§
            serviceCheckboxes.forEach(cb => {
                cb.addEventListener("change", calculateAndUpdate);
            });

            cashInput.addEventListener("input", function () {
                // Ø­Ø°Ù Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²
                this.value = this.value.replace(/[^\d]/g, '');
                calculateAndUpdate();
            });

            form.addEventListener("submit", function (e) {
                calculateAndUpdate();
                if (!form.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert("Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ÛŒ ÙØ±Ù… Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯.");
                }
            });

            // Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            calculateAndUpdate();
        });
    </script>
{% endblock %}

