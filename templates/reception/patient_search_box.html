<div class="position-relative">
  <input id="patient-search" type="text" class="form-control form-control-sm" placeholder="Ø¬Ø³ØªØ¬Ùˆ (Ù†Ø§Ù…ØŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ØŒ Ú©Ø¯ Ù…Ù„ÛŒ)" autocomplete="off">
  <div id="search-loader" class="position-absolute top-50 end-0 translate-middle-y me-2 d-none">
    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
  </div>
  <ul id="patient-suggestions" class="list-group position-absolute w-100 shadow-sm bg-white border" style="z-index: 1000; top: 100%; display: none;"></ul>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("patient-search");
  const list = document.getElementById("patient-suggestions");
  const loader = document.getElementById("search-loader");
  let timeout = null;
  let selectedIndex = -1;

  function clearSuggestions() {
    list.innerHTML = "";
    list.style.display = "none";
    selectedIndex = -1;
  }

  input.addEventListener("input", function () {
    clearTimeout(timeout);
    const query = this.value.trim();
    if (!query || query.length < 2) {
      clearSuggestions();
      return;
    }

    loader.classList.remove("d-none");

    timeout = setTimeout(() => {
      fetch(`/patient/api/patients/search/?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
  list.innerHTML = "";
  loader.classList.add("d-none");

  data.results.forEach((p, i) => {
    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
    li.dataset.index = i;
    li.innerHTML = `
      <span>${p.full_name} - ${p.mobile}</span>
      <a class="btn btn-sm btn-success" href="/reception/create/?patient_id=${p.id}">Ø«Ø¨Øª Ù¾Ø°ÛŒØ±Ø´</a>
    `;
    list.appendChild(li);
  });

  // â• Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ø§Ø± Ù‡Ù…ÛŒØ´Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
  const createLi = document.createElement("li");
  createLi.className = "list-group-item text-muted d-flex justify-content-between align-items-center";
  createLi.innerHTML = `
    <span>ğŸ‘¤ Ù‡Ù†ÙˆØ² Ù…Ø·Ù…Ø¦Ù† Ù†ÛŒØ³ØªÛŒØ¯ØŸ</span>
    <a href="/patient/register/?q=${query}" class="btn btn-sm btn-outline-primary">â• Ø§ÛŒØ¬Ø§Ø¯ Ø¨ÛŒÙ…Ø§Ø±</a>
  `;
  list.appendChild(createLi);

  list.style.display = "block";
})
        .catch(() => {
          loader.classList.add("d-none");
          list.innerHTML = `<li class="list-group-item text-danger">â›” Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</li>`;
          list.style.display = "block";
        });
    }, 300);
  });

  // Ú©ÛŒØ¨ÙˆØ±Ø¯
  input.addEventListener("keydown", function (e) {
    const items = list.querySelectorAll("li");
    if (items.length === 0) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      selectedIndex = (selectedIndex + 1) % items.length;
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      selectedIndex = (selectedIndex - 1 + items.length) % items.length;
    } else if (e.key === "Enter") {
      e.preventDefault();
      const selected = items[selectedIndex];
      if (selected) {
        const btn = selected.querySelector("a.btn-success");
        if (btn) window.location.href = btn.href;
      }
    }

    items.forEach((item, idx) => {
      item.classList.toggle("active", idx === selectedIndex);
    });
  });

  document.addEventListener("click", function (e) {
    if (!list.contains(e.target) && e.target !== input) {
      clearSuggestions();
    }
  });
});
</script>