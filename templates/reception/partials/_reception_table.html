{% load static %}
{% load service_filters %}
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle text-center">
    <thead>
      <tr>
        <th>Ú©Ø¯ Ù¾Ø°ÛŒØ±Ø´</th>
        <th>Ø³Ø·Ø­ Ø®Ø¯Ù…Øª</th>
        <th>Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±ÙˆÙ†Ø¯Ù‡</th>
        <th>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th>
        <th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th>
        <th>Ù†ÙˆØ¹ Ø®Ø¯Ù…Øª</th>
        <th>Ù†ÙˆØ¨Øª</th>
        <th>ÙˆØ¶Ø¹ÛŒØª Ø®Ø¯Ù…Øª</th>
        <th>ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª</th>
        <th class="text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
      </tr>
    </thead>
    <tbody>
      {% for r in receptions %}
        {% with r.services.all as services %}
          {% if services %}
            {% for s in services %}
              <tr class="{% if forloop.first %}table-primary fw-bold{% endif %}">
                {% if forloop.first %}
                  <td rowspan="{{ services|length }}">{{ r.admission_code }}</td>
                  <td rowspan="{{ services|length }}">{{ r.get_service_level_display }}</td>
                  <td rowspan="{{ services|length }}">{{ r.patient.record_number }}</td>
                  <td rowspan="{{ services|length }}">{{ r.patient.full_name }}</td>
                  <td rowspan="{{ services|length }}">{{ r.patient.mobile }}</td>
                {% endif %}
                <td>{{ s.get_service_type_display }}</td>
                <td>{{ s.service_index|default:"â€”" }}</td>
                <td>{{ s|status_badge|safe }}</td>
                <td>
                  {% if r.is_fully_paid %}
                    <span class="badge bg-success">ØªØ³ÙˆÛŒÙ‡â€ŒØ´Ø¯Ù‡</span>
                  {% else %}
                    <span class="badge bg-danger">Ø¨Ø¯Ù‡Ú©Ø§Ø±</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                      Ø¹Ù…Ù„ÛŒØ§Øª
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="{% url 'reception:service-done' s.id %}">âœ… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</a></li>
                      <li><a class="dropdown-item" href="{% url 'reception:service-cancel' s.id %}">ğŸš« Ú©Ù†Ø³Ù„</a></li>
                      <li><a class="dropdown-item" href="#">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</a></li>
                    </ul>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr class="table-light">
              <td>{{ r.get_service_level_display }}</td>
              <td>{{ r.patient.record_number }}</td>
              <td>{{ r.patient.full_name }}</td>
              <td>{{ r.patient.mobile }}</td>
              <td colspan="6" class="text-muted">
                <div class="d-flex justify-content-center align-items-center gap-2">
                  âŒ Ø®Ø¯Ù…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
                  <a href="{% url 'reception:add-service' r.id %}" class="btn btn-sm btn-outline-primary">â• Ø§ÙØ²ÙˆØ¯Ù† Ø®Ø¯Ù…Øª</a>
                </div>
              </td>
            </tr>
          {% endif %}
        {% endwith %}
      {% empty %}
        <tr>
          <td colspan="10" class="text-center text-muted">â›” Ù¾Ø°ÛŒØ±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>