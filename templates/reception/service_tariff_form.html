{% extends "base.html" %}
{% load static %}

{% block title %}ÙØ±Ù… ØªØ¹Ø±ÙÙ‡{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="mb-0">{{ view.object.pk|yesno:"ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ¹Ø±ÙÙ‡,Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø±ÙÙ‡ Ø¬Ø¯ÛŒØ¯" }}</h2>
        </div>
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                    <p class="mb-0">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-md-6"> {# ÙÛŒÙ„Ø¯ service_type #}
                        <label for="{{ form.service_type.id_for_label }}" class="form-label">
                            {{ form.service_type.label }}{% if form.service_type.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.service_type }}
                        {% if form.service_type.errors %}{{ form.service_type.errors }}{% endif %}
                    </div>
                    <div class="col-md-6"> {# ÙÛŒÙ„Ø¯ amount #}
                        <label for="{{ form.amount.id_for_label }}" class="form-label">
                            {{ form.amount.label }}{% if form.amount.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.amount }}
                        {% if form.amount.errors %}{{ form.amount.errors }}{% endif %}
                    </div>
                    <div class="col-md-6"> {# ÙÛŒÙ„Ø¯ valid_from #}
                        <label for="{{ form.valid_from.id_for_label }}" class="form-label">
                            {{ form.valid_from.label }}{% if form.valid_from.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.valid_from }}
                        {% if form.valid_from.errors %}{{ form.valid_from.errors }}{% endif %}
                    </div>
                    <div class="col-md-6"> {# ÙÛŒÙ„Ø¯ valid_to #}
                        <label for="{{ form.valid_to.id_for_label }}" class="form-label">
                            {{ form.valid_to.label }}{% if form.valid_to.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.valid_to }}
                        {% if form.valid_to.errors %}{{ form.valid_to.errors }}{% endif %}
                    </div>
                    <div class="col-md-6"> {# ÙÛŒÙ„Ø¯ insurance_coverage #}
                        <label for="{{ form.insurance_coverage.id_for_label }}" class="form-label">
                            {{ form.insurance_coverage.label }}{% if form.insurance_coverage.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.insurance_coverage }}
                        {% if form.insurance_coverage.errors %}{{ form.insurance_coverage.errors }}{% endif %}
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-3">Ø°Ø®ÛŒØ±Ù‡</button>
                <a href="{% url 'reception:tariff_list' %}" class="btn btn-secondary mt-3">Ø¨Ø§Ø²Ú¯Ø´Øª</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ğŸ¯ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙØ±Ù…Øª Ù…Ø¨Ù„Øº Ø¯Ø§Ø±Ù†Ø¯
        const amountInputs = document.querySelectorAll('input.amount-input');

        amountInputs.forEach(function (input) {
            // ØªØ§Ø¨Ø¹ Ø­Ø°Ù ØºÛŒØ± Ø¹Ø¯Ø¯ (clean)
            function cleanNumber(value) {
                return value.replace(/\D/g, '');
            }

            // ØªØ§Ø¨Ø¹ ÙØ±Ù…Øª Ø¨Ø§ Ù†Ù‚Ø·Ù‡ (separator)
            function formatNumber(value) {
                const cleaned = cleanNumber(value);
                if (!cleaned || cleaned === '0') return cleaned;
                return cleaned.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            // ğŸ“Œ Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÙ¾ (input)
            input.addEventListener('input', function (e) {
                const rawValue = e.target.value;
                const cursorPos = e.target.selectionStart;

                const digitsBeforeCursor = cleanNumber(rawValue.slice(0, cursorPos)).length;

                const formattedValue = formatNumber(rawValue);
                e.target.value = formattedValue;

                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø±Ø³Ø± Ø¬Ø¯ÛŒØ¯
                let currentDigits = 0;
                let newCursor = 0;
                while (currentDigits < digitsBeforeCursor && newCursor < formattedValue.length) {
                    if (/\d/.test(formattedValue[newCursor])) {
                        currentDigits++;
                    }
                    newCursor++;
                }

                e.target.setSelectionRange(newCursor, newCursor);
            });

            // ğŸ“Œ Ù‡Ù†Ú¯Ø§Ù… blur ÛŒØ§ paste
            input.addEventListener('blur', function (e) {
                e.target.value = formatNumber(e.target.value);
            });

            input.addEventListener('paste', function (e) {
                const paste = e.clipboardData.getData('text');
                if (!/\d/.test(paste)) {
                    e.preventDefault();
                }
            });

            // ğŸ“Œ Ø¯Ø± Ø²Ù…Ø§Ù† Ù„ÙˆØ¯ØŒ ÙØ±Ù…Øª Ú©Ù† (Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª edit)
            input.value = formatNumber(input.value);

            // ğŸ“Œ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…ØŒ Ø¹Ø¯Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù†
            const form = input.closest('form');
            if (form) {
                form.addEventListener('submit', function () {
                    input.value = cleanNumber(input.value);
                });
            }
        });
    });
</script>
{% endblock %}