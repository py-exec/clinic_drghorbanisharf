{% extends "base.html" %}
{% load static %}

{% block title %}{{ view.object|default_if_none:"Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯" }}{% endblock %}

{% block content %}
<h4 class="py-3 mb-4">
    <span class="text-muted fw-light">Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ / ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ /</span>
    {% if view.object %}âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±{% else %}â• Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯{% endif %}
</h4>

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            {% if view.object %}ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±: {{ view.object.invoice_number }}{% else %}Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯{% endif %}
        </h5>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="invoice-form"> {# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† id Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ JS #}
            {% csrf_token %}
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                <p class="mb-0">{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}

            <div class="row g-3">

                {% if view.object %}
                <div class="col-md-6">
                    <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</label>
                    <input type="text" class="form-control" value="{{ view.object.invoice_number }}" disabled>
                </div>
                {% endif %}

                <div class="col-md-6">
                    <label for="{{ form.related_user.id_for_label }}" class="form-label">
                        {{ form.related_user.label }}{% if form.related_user.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {{ form.related_user }}
                    {% if form.related_user.errors %}{{ form.related_user.errors }}{% endif %}
                </div>

                <div class="col-md-6">
                    <label for="{{ form.related_reception.id_for_label }}" class="form-label">
                        {{ form.related_reception.label }}{% if form.related_reception.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {{ form.related_reception }}
                    {% if form.related_reception.errors %}{{ form.related_reception.errors }}{% endif %}
                </div>

                <div class="col-md-6">
                    <label for="{{ form.discount.id_for_label }}" class="form-label">
                        {{ form.discount.label }}{% if form.discount.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {{ form.discount }}
                    {% if form.discount.errors %}{{ form.discount.errors }}{% endif %}
                </div>

                <div class="col-md-6">
                    <label for="{{ form.status.id_for_label }}" class="form-label">
                        {{ form.status.label }}{% if form.status.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {{ form.status }}
                    {% if form.status.errors %}{{ form.status.errors }}{% endif %}
                </div>

                <div class="col-md-6 form-check mt-4 pt-2"> {# Ú©Ù„Ø§Ø³ Ù‡Ø§ÛŒ Bootstrap Ø¨Ø±Ø§ÛŒ Ú†Ú©â€ŒØ¨Ø§Ú©Ø³ #}
                    {{ form.is_paid }} {{ form.is_paid.label_tag }}
                    {% if form.is_paid.errors %}{{ form.is_paid.errors }}{% endif %}
                </div>

                <div class="col-12"> {# ØªÙ…Ø§Ù… Ø¹Ø±Ø¶ #}
                    <label for="{{ form.notes.id_for_label }}" class="form-label">
                        {{ form.notes.label }}{% if form.notes.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}{{ form.notes.errors }}{% endif %}
                </div>

                {# Ø§Ú¯Ø± Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø±Ø§ Ø¯Ø± ÙØ±Ù… ModelForm Ø®ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª disabled ÛŒØ§ ReadOnly ØªÙ†Ø¸ÛŒÙ… Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø§Ø´Ø¯. #}
                {# Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø¢Ù† Ø±Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± view/template Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ Ù†Ù‡ Ø¯Ø± ÙØ±Ù… ÙˆØ±ÙˆØ¯ÛŒ. #}
                {# Ø§Ú¯Ø± Ø¨Ø§ÛŒØ¯ Ø¯Ø± ÙØ±Ù… Ø¨Ø§Ø´Ø¯ Ø§Ù…Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ØŒ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù‡ Ø¯Ø± ÙØ±Ù… ModelForm ÙˆÛŒØ¬Øª Ø¢Ù† Ø±Ø§ disabled Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. #}
                <div class="col-md-6">
                    <label for="{{ form.created_by.id_for_label }}" class="form-label">
                        {{ form.created_by.label }}{% if form.created_by.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {{ form.created_by }}
                    {% if form.created_by.errors %}{{ form.created_by.errors }}{% endif %}
                </div>
            </div>

            <div class="mt-4 d-flex gap-2 justify-content-end">
                <a href="{% url 'accounting:invoice_list' %}" class="btn btn-secondary btn-sm">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</a>
                <button type="submit" class="btn btn-primary btn-sm">
                    {% if view.object %}ğŸ’¾ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ{% else %}ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('invoice-form'); // Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ ÙØ±Ù… Ø¨Ø§ ID Ø¬Ø¯ÛŒØ¯
        if (form) {
            const formInputs = form.querySelectorAll('input:not([type="checkbox"]):not([type="file"]):not([type="submit"]):not([type="reset"]), select, textarea');

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³ form-control Ø¨Ù‡ ØªÙ…Ø§Ù… input, select, textarea Ù‡Ø§
            formInputs.forEach(input => {
                if (!input.classList.contains('form-control')) {
                    input.classList.add('form-control');
                }
            });

            // Ù…Ù†Ø·Ù‚ Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Û³ Ø±Ù‚Ù… Û³ Ø±Ù‚Ù… Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯ Ù…Ø¨Ù„Øº (discount)
            const discountInput = document.getElementById('{{ form.discount.id_for_label }}');

            if (discountInput) {
                function cleanNumber(value) {
                    return String(value).replace(/\D/g, ''); // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ value Ø±Ø´ØªÙ‡ Ø§Ø³Øª
                }

                function formatNumberWithSeparators(value) {
                    const cleanedValue = cleanNumber(value);
                    if (cleanedValue === '' || cleanedValue === '0') {
                        return cleanedValue;
                    }
                    return cleanedValue.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                }

                discountInput.addEventListener('input', function (e) {
                    const originalValue = e.target.value;
                    const originalCursorPosition = e.target.selectionStart;

                    const formattedValue = formatNumberWithSeparators(originalValue);
                    e.target.value = formattedValue;

                    let newCursorPosition = originalCursorPosition;
                    const dotsAdded = (formattedValue.length - originalValue.length);

                    // Adjust cursor position
                    if (dotsAdded > 0 && originalCursorPosition > 0 && formattedValue.charAt(originalCursorPosition - 1) === '.') {
                        newCursorPosition += 1;
                    } else if (dotsAdded < 0 && originalCursorPosition > 0 && originalValue.charAt(originalCursorPosition - 1) === '.' && originalValue.charAt(originalCursorPosition) !== '.') {
                        newCursorPosition -= 1;
                    }
                    // Ensure cursor stays within bounds
                    newCursorPosition = Math.min(newCursorPosition, formattedValue.length);
                    e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                });

                discountInput.addEventListener('blur', function (e) {
                    e.target.value = formatNumberWithSeparators(e.target.value);
                });

                discountInput.value = formatNumberWithSeparators(discountInput.value);

                discountInput.form.addEventListener('submit', function () {
                    discountInput.value = cleanNumber(discountInput.value);
                });
            }
        }
    });
</script>
{% endblock %}