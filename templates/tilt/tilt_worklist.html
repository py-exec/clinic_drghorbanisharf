{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}ğŸ“‹ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±ÛŒ ØªØ³Øª ØªÛŒÙ„Øª{% endblock %}

{% block content %}
    <h4 class="py-3 mb-4">
        <span class="text-muted fw-light">Ø®Ø¯Ù…Ø§Øª Ú©Ù„ÛŒÙ†ÛŒÚ©ÛŒ /</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±ÛŒ ØªØ³Øª ØªÛŒÙ„Øª
    </h4>

    <!-- Ø¨Ø®Ø´ Ø¢Ù…Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡ -->
    <div class="row g-4 mb-4">
        <div class="col-sm-6 col-xl-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="content-left">
                            <span>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²</span>
                            <div class="d-flex align-items-end mt-2">
                                <h3 class="mb-0 me-2" data-type="done_today">{{ done_today|intcomma }}</h3>
                            </div>
                            <small>ØªØ¹Ø¯Ø§Ø¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</small>
                        </div>
                        <span class="badge bg-label-success rounded p-2">
                        <i class="bx bx-check-double bx-sm"></i>
                    </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="content-left">
                            <span>Ø¯Ø± ØµÙ Ø§Ù†ØªØ¸Ø§Ø±</span>
                            <div class="d-flex align-items-end mt-2">
                                <h3 class="mb-0 me-2" data-type="in_queue">{{ in_queue|intcomma }}</h3>
                            </div>
                            <small>Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ù¾Ø°ÛŒØ±Ø´ Ø´Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²</small>
                        </div>
                        <span class="badge bg-label-warning rounded p-2">
                        <i class="bx bx-time-five bx-sm"></i>
                    </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="content-left">
                            <span>Ú©Ù„ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</span>
                            <div class="d-flex align-items-end mt-2">
                                <h3 class="mb-0 me-2" data-type="total_scheduled">{{ total_scheduled|intcomma }}</h3>
                            </div>
                            <small>ØªØ¹Ø¯Ø§Ø¯ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯Ù‡</small>
                        </div>
                        <span class="badge bg-label-info rounded p-2">
                        <i class="bx bx-calendar-event bx-sm"></i>
                    </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ù„ÛŒØ³Øª Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Ù„ÛŒØ³Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† (Ø§Ù…Ø±ÙˆØ²)</h5>
            <a href="{% url 'tilt:tilt_report_archive' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bx bx-archive me-1"></i> Ø¢Ø±Ø´ÛŒÙˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
            </a>
        </div>
        <div class="table-responsive text-nowrap">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±</th>
                    <th>Ú©Ø¯ Ù¾Ø°ÛŒØ±Ø´</th>
                    <th>Ø²Ù…Ø§Ù† Ù¾Ø°ÛŒØ±Ø´</th>
                    <th>ÙˆØ¶Ø¹ÛŒØª Ø®Ø¯Ù…Øª</th>
                    <th class="text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr>
                </thead>
                <tbody id="waiting-list-table-body">
                {% for service in waiting_list %}
                    <tr id="service-row-{{ service.pk }}">
                        <td><strong>{{ service.reception.patient.full_name }}</strong></td>
                        <td>{{ service.reception.admission_code }}</td>
                        <td>{{ service.created_at|date:"H:i" }}</td>
                        <td>
                            {% if service.latest_status_value == 'pending' %}
                                <span class="badge bg-label-warning me-1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
                            {% elif service.latest_status_value == 'in_progress' %}
                                <span class="badge bg-label-info me-1">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</span>
                            {% elif service.latest_status_value == 'done' %}
                                <span class="badge bg-label-success me-1">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</span>
                            {% elif service.latest_status_value == 'cancelled' %}
                                <span class="badge bg-label-danger me-1">Ù„ØºÙˆ Ø´Ø¯Ù‡</span>
                            {% else %}
                                <span class="text-muted">Ù†Ø§Ù…Ø´Ø®Øµ</span>
                            {% endif %}
                        </td>


                        <td class="text-center">
                            <a href="{% url 'tilt:tilt_create' service.pk %}" class="btn btn-primary btn-sm">
                                <i class="bx bx-edit-alt me-1"></i> Ø´Ø±ÙˆØ¹ Ùˆ Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´
                            </a>
                        </td>
                    </tr>
                {% empty %}
                    <tr id="no-patient-row">
                        <td colspan="5" class="text-center py-4">Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ø¯Ø± ØµÙ Ø§Ù†ØªØ¸Ø§Ø± Ù†ÛŒØ³Øª.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const waitingListTableBody = document.getElementById('waiting-list-table-body');
        const noPatientRow = document.getElementById('no-patient-row');

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† data-type Ø¨Ù‡ Ù‡Ø¯Ø± Ø¢Ù…Ø§Ø±
        const doneTodayElem = document.querySelector("h3[data-type='done_today']");
        const inQueueElem = document.querySelector("h3[data-type='in_queue']");
        const totalScheduledElem = document.querySelector("h3[data-type='total_scheduled']");

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø² API
        function updateDashboardStats() {
            fetch("{% url 'tilt:tilt_dashboard_stats' %}")
                .then(response => response.json())
                .then(data => {
                    doneTodayElem.textContent = data.done_today.toLocaleString('fa-IR');
                    inQueueElem.textContent = data.in_queue.toLocaleString('fa-IR');
                    totalScheduledElem.textContent = data.total_scheduled.toLocaleString('fa-IR');
                })
                .catch(error => console.error("âŒ Dashboard stats fetch error:", error));
        }

        // WebSocket setup
        const tiltSocket = new WebSocket(`ws://${window.location.host}/ws/reception/updates/`);

        tiltSocket.onopen = () => {
            console.log("âœ… WebSocket connection opened for Tilt Worklist");
        };

        tiltSocket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            const service = data.service;

            if (service?.service_name === "ØªØ³Øª ØªÛŒÙ„Øª") {
                const rowId = `service-row-${service.id}`;
                const serviceRow = document.getElementById(rowId);

                if (data.action === 'service_created' && !serviceRow) {
                    // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª
                    if (noPatientRow) noPatientRow.remove();

                    const newRow = `
                        <tr id="${rowId}">
                            <td><strong>${service.patient_name}</strong></td>
                            <td>${service.reception_code}</td>
                            <td>${new Date(service.created_at).toLocaleTimeString('fa-IR')}</td>
                            <td><span class="badge bg-label-warning me-1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span></td>
                            <td class="text-center">
                                <a href="/services/tilt/create/for-service/${service.id}/" class="btn btn-primary btn-sm">
                                    <i class="bx bx-edit-alt me-1"></i> Ø´Ø±ÙˆØ¹ Ùˆ Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´
                                </a>
                            </td>
                        </tr>
                    `;
                    waitingListTableBody.insertAdjacentHTML('beforeend', newRow);
                }

                if (serviceRow && ['done', 'cancelled'].includes(service.status_code)) {
                    serviceRow.remove();
                    if (waitingListTableBody.children.length === 0) {
                        waitingListTableBody.innerHTML = `
                            <tr id="no-patient-row">
                                <td colspan="5" class="text-center py-4">
                                    Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ø¯Ø± ØµÙ Ø§Ù†ØªØ¸Ø§Ø± Ù†ÛŒØ³Øª.
                                </td>
                            </tr>`;
                    }
                }

                updateDashboardStats(); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ±
            }
        };

        tiltSocket.onclose = () => {
            console.warn("âš ï¸ WebSocket for Tilt Worklist closed.");
        };
    });
</script>
{% endblock %}
