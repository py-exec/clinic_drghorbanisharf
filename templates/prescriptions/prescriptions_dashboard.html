{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}๐ ุฏุงุดุจูุฑุฏ ูุณุฎูโูุง{% endblock %}

{% block content %}
<h4 class="py-3 mb-4">
    <span class="text-muted fw-light">ูพุฒุดฺฉ /</span> ุฏุงุดุจูุฑุฏ ูุณุฎูโูุง ู ูุธุฑุงุช ูพุฒุดฺฉ
</h4>

<div class="row g-4 mb-4">
    <div class="col-sm-6 col-xl-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-start justify-content-between">
                    <div class="content-left">
                        <span>ฺฉู ูุณุฎูโูุง ุงูุฑูุฒ</span>
                        <div class="d-flex align-items-end mt-2">
                            <h3 class="mb-0 me-2" data-type="total_prescriptions_today">{{ total_prescriptions_today|intcomma }}</h3>
                        </div>
                        <small>ุชุนุฏุงุฏ ูุณุฎูโูุง ุซุจุช ุดุฏู ุงูุฑูุฒ</small>
                    </div>
                    <span class="badge bg-label-primary rounded p-2">
                        <i class="bx bx-file-medical bx-sm"></i>
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-6 col-xl-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-start justify-content-between">
                    <div class="content-left">
                        <span>ูุณุฎูโูุง ููุง ุดุฏู ุงูุฑูุฒ</span>
                        <div class="d-flex align-items-end mt-2">
                            <h3 class="mb-0 me-2" data-type="finalized_prescriptions_today">{{ finalized_prescriptions_today|intcomma }}</h3>
                        </div>
                        <small>ูุณุฎูโูุง ุจุง ูุธุฑ ููุง ูพุฒุดฺฉ</small>
                    </div>
                    <span class="badge bg-label-success rounded p-2">
                        <i class="bx bx-check-double bx-sm"></i>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-xl-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-start justify-content-between">
                    <div class="content-left">
                        <span>ูุณุฎูโูุง ุฏุฑ ุงูุชุธุงุฑ ุจุฑุฑุณ</span>
                        <div class="d-flex align-items-end mt-2">
                            <h3 class="mb-0 me-2" data-type="pending_review_prescriptions">{{ pending_review_prescriptions|intcomma }}</h3>
                        </div>
                        <small>ูุณุฎูโูุง ฺฉู ูุงุฒ ุจู ูพฺฏุฑ ุฏุงุฑูุฏ</small>
                    </div>
                    <span class="badge bg-label-warning rounded p-2">
                        <i class="bx bx-time-five bx-sm"></i>
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    </div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ูุณุฎูโูุง ุงุฎุฑ</h5>
                <a href="{% url 'prescriptions:prescription_list' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bx bx-list-ul me-1"></i> ูุดุงูุฏู ููู
                </a>
            </div>
            <div class="table-responsive text-nowrap">
                {# ูโุชูุงูุฏ ุงูุฌุง ฺฉ ุฌุฏูู ฺฉูฺฺฉ ุจุฑุง ููุงุด ฺูุฏ ูุณุฎู ุงุฎุฑ ุงุถุงูู ฺฉูุฏ #}
                {# ูุซูุงู: {% include "prescriptions/partials/_recent_prescriptions_table.html" %} #}
                {# ุง ููุท ฺฉ ูพุงู ุณุงุฏู: #}
                <div class="p-4 text-muted">
                    ุงู ุจุฎุด ูโุชูุงูุฏ ุดุงูู ูุณุฎูโูุง ุจุงุดุฏ ฺฉู ูุงุฒ ุจู ุชุฃุฏ ุฏุงุฑูุฏุ ุง ูุณุฎูโูุง ฺฉู ุงุฎุฑุงู ุตุงุฏุฑ ุดุฏูโุงูุฏ.
                    ูพุงุฏูโุณุงุฒ ุขู ูุงุฒููุฏ ฺฉูุฆุฑโูุง ุงุถุงู ุฏุฑ `views.py` ู ฺฉ ูุงูุจ `partial` ุงุณุช.
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Elements for dashboard stats
        const totalPrescriptionsTodayElem = document.querySelector("h3[data-type='total_prescriptions_today']");
        const finalizedPrescriptionsTodayElem = document.querySelector("h3[data-type='finalized_prescriptions_today']");
        const pendingReviewPrescriptionsElem = document.querySelector("h3[data-type='pending_review_prescriptions']");

        // Function to update dashboard stats from an API (if you had one, otherwise, initial load is enough)
        // Since stats are calculated on page load in views.py, WebSocket updates are for real-time changes
        // which would require a dedicated API endpoint or more complex signal processing.
        // For now, this function is primarily for potential future WebSocket integration.
        function updateDashboardStats(data) {
            if (totalPrescriptionsTodayElem) totalPrescriptionsTodayElem.textContent = data.total_prescriptions_today.toLocaleString('fa-IR');
            if (finalizedPrescriptionsTodayElem) finalizedPrescriptionsTodayElem.textContent = data.finalized_prescriptions_today.toLocaleString('fa-IR');
            if (pendingReviewPrescriptionsElem) pendingReviewPrescriptionsElem.textContent = data.pending_review_prescriptions.toLocaleString('fa-IR');
        }

        // WebSocket setup (if you decide to send real-time stats for Prescriptions)
        // This would require modifying apps/reception/signals.py to also calculate and send
        // Prescription specific stats, or having a separate consumer/channel.
        // const prescriptionsSocket = new WebSocket(`ws://${window.location.host}/ws/prescriptions/updates/`);
        // prescriptionsSocket.onopen = () => { console.log("โ WebSocket connection opened for Prescriptions Dashboard"); };
        // prescriptionsSocket.onmessage = (e) => {
        //     const data = JSON.parse(e.data);
        //     console.log("Received WebSocket message:", data);
        //     if (data.stats && data.stats.prescriptions_dashboard) { // Assuming stats come nested
        //         updateDashboardStats(data.stats.prescriptions_dashboard);
        //     }
        // };
        // prescriptionsSocket.onclose = () => { console.warn("โ๏ธ WebSocket for Prescriptions Dashboard closed."); };
    });
</script>
{% endblock %}